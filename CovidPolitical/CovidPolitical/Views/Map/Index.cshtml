@{
    ViewData["Title"] = "Covid Political";
}

<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <link rel="shortcut icon" href="">
    <script src="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.css" rel="stylesheet" />
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }

        #menu {
            position: relative;
            float: right;
            background: #fff;
            padding: 10px;
            font-family: 'Open Sans', sans-serif;
        }
    </style>
</head>

<body>
    <style>
        .map-overlay {
            font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
            background-color: #fff;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            border-radius: 3px;
            position: absolute;
            width: 25%;
            top: 10px;
            left: 10px;
            padding: 10px;
            display: none;
        }
    </style>
    <div id="map"></div>
    <div id="map-overlay" class="map-overlay"></div>

    <div id="menu">
        <input id="confirmed" type="radio" name="rcovid" value="confirmed" checked="checked" />
        <label for="confirmed">Confirmed</label>
        <input id="deaths" type="radio" name="rcovid" value="deaths" />
        <label for="deaths">Deaths</label>
        <input id="active" type="radio" name="rcovid" value="active" />
        <label for="active">Active</label>
        <hr />
        <input id="actual" type="radio" name="rfilter" value="actual" checked="checked" />
        <label for="actual">Actual</label>
        <input id="per100k" type="radio" name="rfilter" value="per100k" />
        <label for="per100k">Per 100k</label>
    </div>

    <script>

        mapboxgl.accessToken = 'pk.eyJ1IjoicnlhbnRpbW90aHkiLCJhIjoiY2tlNXN5bjRrMGJ6NjJybjVpenJlODZ1NiJ9.6YxFfsow9guHOa4PzBnN_A';

        var map = new mapboxgl.Map({
            'container': 'map',
            'style': 'mapbox://styles/mapbox/dark-v10',
            'center': [-98, 38.88],
            'minZoom': 2,
            'zoom': 4
        });

        var overlay = document.getElementById('map-overlay');

        // Create a popup, but don't add it to the map yet.
        var popup = new mapboxgl.Popup({
            closeButton: false
        });

        var covidInputs = document.getElementsByName('rcovid');
        var filterInputs = document.getElementsByName('rfilter');

        var expressionValues = {
            'actual': {
                'confirmed': 'confirmed',
                'deaths': 'deaths',
                'active': 'active',
            },
            'per100k': {
                'confirmed': 'confirmedPer100k',
                'deaths': 'deathsPer100k',
                'active': 'activePer100k',
            },
        }

        for (var i = 0; i < covidInputs.length; i++) {
            covidInputs[i].onclick = covidOnClick;
        }

        for (var i = 0; i < filterInputs.length; i++) {
            filterInputs[i].onclick = filterOnClick;
        }

        function covidOnClick(covid) {
            setCovidPointFeatureValue(covid.target.value, document.querySelector('input[name="rfilter"]:checked').value);
        }

        function filterOnClick(filter) {
            setCovidPointFeatureValue(document.querySelector('input[name="rcovid"]:checked').value, filter.target.value);
        }

        function setCovidPointFeatureValue(covid, filter) {
            let expressionValue = expressionValues[filter][covid]

            map.setPaintProperty('covid-point', 'circle-radius',
                [
                    'interpolate',
                    ['linear'],
                    ['zoom'],
                    3,
                    ['interpolate',
                        ['linear'],
                        ['get', expressionValue],
                        1750, 0.1,
                        25000, 8],
                    30,
                    ['interpolate',
                        ['linear'],
                        ['get', expressionValue],
                        1750, 40,
                        25000, 150]
                ]);

            map.setPaintProperty('covid-point', 'circle-color',
                [
                    'interpolate',
                    ['linear'],
                    ['get', expressionValue],
                    1750,
                    'rgba(239, 232, 120,0)',
                    7000,
                    '#feffd9',
                    30000,
                    '#ffffff'
                ]);

            map.setPaintProperty('covid-point', 'circle-stroke-color',
                [
                    'interpolate',
                    ['linear'],
                    ['get', expressionValue],
                    0.0,
                    'transparent',
                    10000,
                    'white',
                    23000,
                    'black'
                ]);
        }

        map.on('load', async function () {
            // source: US counties for political fill & border around county
            map.addSource('counties-source', {
                'type': 'vector',
                'url': 'mapbox://mapbox.82pkq93d',
                'promoteId': { 'original': 'FIPS' },
            });

            map.addSource('counties', {
                'type': 'vector',
                'url': 'mapbox://mapbox.82pkq93d'
            });

            // source: US state for border around state
            map.addSource('states-source', {
                'type': 'geojson',
                'data':
                    'https://docs.mapbox.com/mapbox-gl-js/assets/us_states.geojson'
            });

            // county border & fill color by political percentage
            map.addLayer(
                {
                    'id': 'counties-layer',
                    'type': 'fill',
                    'source': 'counties-source',
                    'source-layer': 'original',
                    'paint': {
                        'fill-outline-color': '#666666',
                        'fill-color': [
                            'case',
                            ['>',
                                ['feature-state', 'DemPercentage'],
                                ['feature-state', 'GopPercentage']],
                            // democrat county
                            ['interpolate',
                                ['linear'],
                                ['-', ['feature-state', 'DemPercentage'], ['feature-state', 'GopPercentage']],
                                0, 'white',
                                0.3, 'blue'],
                            // republican county
                            ['interpolate',
                                ['linear'],
                                ['-', ['feature-state', 'GopPercentage'], ['feature-state', 'DemPercentage']],
                                0, 'white',
                                0.3, 'red'],
                        ],
                        'fill-opacity': 0.5
                    },
                }
            );

            // state border
            map.addLayer(
                {
                    'id': 'state-borders',
                    'type': 'line',
                    'source': 'states-source',
                    'layout': {},
                    'paint': {
                        'line-color': '#cdcdcd',
                        'line-width': 1
                    }
                },
                'waterway-label'
            );

            map.addLayer(
                {
                    'id': 'counties',
                    'type': 'fill',
                    'source': 'counties',
                    'source-layer': 'original',
                    'paint': {
                        'fill-outline-color': 'rgba(0,0,0,0.1)',
                        'fill-color': 'rgba(0,0,0,0.1)'
                    }
                },
                'settlement-label'
            ); // Place polygon under these labels.

            map.addLayer(
                {
                    'id': 'counties-highlighted',
                    'type': 'fill',
                    'source': 'counties-source',
                    'source-layer': 'original',
                    'paint': {
                        'fill-outline-color': '#484896',
                        'fill-color': '#6e599f',
                        'fill-opacity': 0.75
                    },
                    'filter': ['in', 'COUNTY', '']
                },
                'settlement-label'
            ); // Place polygon under these labels.

            // fetch election results - static file
            await fetch('/Data/2016_election_us_counties.json')
                .then(response => response.text())
                .then((data) => {
                    let electionjson = JSON.parse(data);

                    // set for political Democrat/Republican vote percentages
                    electionjson.forEach((item) => {
                        map.setFeatureState(
                            {
                                'source': 'counties-source',
                                'sourceLayer': 'original',
                                'id': item.FIPS,
                            },
                            {
                                'DemPercentage': item.DemPercentage,
                                'GopPercentage': item.GopPercentage,
                            }
                        );
                    });
                });

            let covidResponse = await fetch('api/covid');

            let covidData = await (
                covidResponse.headers.get('content-type').includes('json') ? covidResponse.json() : covidResponse.text()
            );

            // source: covid data for circle at geometry point
            map.addSource('covid-source', {
                'type': 'geojson',
                'data':
                    covidData
            });

            // covid circle
            map.addLayer(
                {
                    'id': 'covid-point',
                    'type': 'circle',
                    'source': 'covid-source',
                    'paint': {
                        'circle-stroke-width': 1,
                    }
                });

            setCovidPointFeatureValue(document.querySelector('input[name="rcovid"]:checked').value, document.querySelector('input[name="rfilter"]:checked').value);

            map.on('mousemove', 'counties', function (e) {
                // Change the cursor style as a UI indicator.
                map.getCanvas().style.cursor = 'pointer';

                // Single out the first found feature.
                var feature = e.features[0];

                // Query the counties layer visible in the map. Use the filter
                // param to only collect results that share the same county name.
                var relatedFeatures = map.querySourceFeatures('counties', {
                    sourceLayer: 'original',
                    filter: ['in', 'COUNTY', feature.properties.COUNTY]
                });

                // Render found features in an overlay.
                overlay.innerHTML = '';

                // Total the population of all features
                var populationSum = relatedFeatures.reduce(function (
                    memo,
                    feature
                ) {
                    return memo + feature.properties.population;
                },
                    0);

                var title = document.createElement('strong');
                title.textContent =
                    feature.properties.COUNTY;

                var population = document.createElement('div');
                population.textContent =
                    'Total population: ' + populationSum.toLocaleString();

                var mapFips = document.createElement('div');
                mapFips.textContent =
                    'FIPS: ' + feature.properties.FIPS.toLocaleString();

                overlay.appendChild(title);
                overlay.appendChild(population);
                overlay.appendChild(mapFips);
                overlay.style.display = 'block';

                // Add features that share the same county name to the highlighted layer.
                map.setFilter('counties-highlighted', [
                    'in',
                    'FIPS',
                    feature.properties.FIPS
                ]);

                // Display a popup with the name of the county
                popup
                    .setLngLat(e.lngLat)
                    .setText(feature.properties.COUNTY)
                    .addTo(map);
            });

            map.on('mouseleave', 'counties', function () {
                map.getCanvas().style.cursor = '';
                popup.remove();
                map.setFilter('counties-highlighted', ['in', 'COUNTY', '']);
                overlay.style.display = 'none';
            });
        });
    </script>
</body>
</html>